<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Детали пациента</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { padding: 20px; }
        .nav-links { margin-bottom: 20px; }
        .batch-chart { margin-bottom: 40px; }
        .chart-container { position: relative; height: 400px; width: 100%; }
    </style>
</head>
<body>
<!-- Блок ссылок на другие страницы -->
<div class="nav-links">
    <h4>Навигация</h4>
    <a href="/patients" class="btn btn-outline-primary">Назад к списку пациентов</a>
    <a href="/diagnoses" class="btn btn-outline-primary">Диагнозы</a>
</div>

<!-- Детали пациента -->
<div class="patient-details">
    <h4>Детали пациента</h4>
    <table class="table">
        <tr>
            <th>ID</th>
            <td th:text="${patient.id}"></td>
        </tr>
        <tr>
            <th>Имя</th>
            <td th:text="${patient.name}"></td>
        </tr>
        <tr>
            <th>Возраст</th>
            <td th:text="${patient.age != null ? patient.age : 'N/A'}"></td>
        </tr>
        <tr>
            <th>pH</th>
            <td th:text="${patient.ph != null ? patient.ph : 'N/A'}"></td>
        </tr>
        <tr>
            <th>CO2</th>
            <td th:text="${patient.co2 != null ? patient.co2 : 'N/A'}"></td>
        </tr>
        <tr>
            <th>Глюкоза</th>
            <td th:text="${patient.glu != null ? patient.glu : 'N/A'}"></td>
        </tr>
        <tr>
            <th>Лактат</th>
            <td th:text="${patient.lac != null ? patient.lac : 'N/A'}"></td>
        </tr>
        <tr>
            <th>BE</th>
            <td th:text="${patient.be != null ? patient.be : 'N/A'}"></td>
        </tr>
        <tr>
            <th>Результат родов</th>
            <td th:text="${patient.childbirthResult.label}"></td>
        </tr>
        <tr>
            <th>Диагнозы</th>
            <td>
                <ul>
                    <li th:each="diagnosis : ${patient.diagnoses}" th:text="${diagnosis.name} + ' (impact: ' + ${diagnosis.impact} + ')'"></li>
                </ul>
            </td>
        </tr>
        <tr>
            <th>Батчи медицинских данных</th>
            <td>
                <div th:each="batch : ${patient.medicalDataBatches}" class="batch-chart">
                    <h5 th:text="${batch.name}"></h5>
                    <div class="chart-container">
                        <canvas th:id="'chart-' + ${batch.id}"></canvas>
                    </div>
                    <a th:href="@{/patients/{patientId}/batches/{batchId}/pdf(patientId=${patient.id},batchId=${batch.id})}" class="btn btn-primary mt-2">Скачать данные в PDF</a>
                </div>
            </td>
        </tr>
    </table>
    <a th:href="@{/patients/{id}/edit(id=${patient.id})}" class="btn btn-warning">Редактировать пациента</a>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    var batches = /*[[${patient.medicalDataBatches}]]*/ [];
    batches.forEach(function(batch) {
        var ctx = document.getElementById('chart-' + batch.id).getContext('2d');
        var times = [];
        var uterusData = [];
        var bpmData = [];
        batch.medicalDataList.forEach(function(data) {
            times.push(data.timeSec);
            uterusData.push(data.uterus !== 0 ? data.uterus : null);
            bpmData.push(data.bpm !== 0 ? data.bpm : null);
        });
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: times,
                datasets: [{
                    label: 'Uterus',
                    data: uterusData,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    spanGaps: true
                }, {
                    label: 'BPM',
                    data: bpmData,
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.1,
                    spanGaps: true
                }]
            },
            options: {
                scales: {
                    x: { title: { display: true, text: 'Time (sec)' } },
                    y: { title: { display: true, text: 'Value' } }
                }
            }
        });
    });
    /*]]>*/
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>