<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Детали пациента</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { padding: 20px; }
        .nav-links { margin-bottom: 20px; }
        .patient-details { margin-bottom: 20px; }
        .batch-chart { margin-bottom: 20px; }
        .chart-container { max-width: 600px; margin-bottom: 10px; }
        .error { color: red; }
    </style>
</head>
<body>
<!-- Блок ссылок на другие страницы -->
<div class="nav-links">
    <h4>Навигация</h4>
    <a href="/patients" class="btn btn-outline-primary">Назад к списку пациентов</a>
    <a href="/diagnoses" class="btn btn-outline-primary">Диагнозы</a>
</div>

<!-- Детали пациента -->
<div class="patient-details">
    <h4>Детали пациента</h4>
    <table class="table table-bordered">
        <tr>
            <th>ID</th>
            <td th:text="${patient.id}"></td>
        </tr>
        <tr>
            <th>Имя</th>
            <td th:text="${patient.name}"></td>
        </tr>
        <tr>
            <th>Возраст</th>
            <td th:text="${patient.age != null} ? ${patient.age} : '-'"></td>
        </tr>
        <tr>
            <th>pH</th>
            <td th:text="${patient.ph != null} ? ${patient.ph} : '-'"></td>
        </tr>
        <tr>
            <th>CO2</th>
            <td th:text="${patient.co2 != null} ? ${patient.co2} : '-'"></td>
        </tr>
        <tr>
            <th>Глюкоза</th>
            <td th:text="${patient.glu != null} ? ${patient.glu} : '-'"></td>
        </tr>
        <tr>
            <th>Лактат</th>
            <td th:text="${patient.lac != null} ? ${patient.lac} : '-'"></td>
        </tr>
        <tr>
            <th>BE</th>
            <td th:text="${patient.be != null} ? ${patient.be} : '-'"></td>
        </tr>
        <tr>
            <th>Результат родов</th>
            <td th:text="${patient.childbirthResultId == 1 ? 'Обычные роды' : 'Гипоксия'}"></td>
        </tr>
        <tr>
            <th>Диагнозы</th>
            <td>
                <ul>
                    <li th:each="diagnosis : ${patient.diagnoses}" th:text="${diagnosis.name} + ' (impact: ' + ${diagnosis.impact} + ')'"></li>
                </ul>
                <span th:if="${patient.diagnoses == null or #lists.isEmpty(patient.diagnoses)}">
                        Нет диагнозов
                    </span>
            </td>
        </tr>
        <tr>
            <th>Батчи медицинских данных</th>
            <td>
                <div th:each="batch : ${patient.medicalDataBatches}" class="batch-chart">
                    <h5 th:text="${batch.name}"></h5>
                    <div class="chart-container">
                        <canvas th:id="'chart-' + ${batch.id}"></canvas>
                    </div>
                    <a th:href="@{/patients/{patientId}/batches/{batchId}/pdf(patientId=${patient.id}, batchId=${batch.id})}" class="btn btn-sm btn-primary mt-2">Скачать данные в PDF</a>
                </div>
                <span th:if="${#lists.isEmpty(patient.medicalDataBatches)}">
                        Батчи данных не найдены
                    </span>
            </td>
        </tr>
    </table>
</div>

<!-- Кнопка редактирования -->
<a th:href="@{/patients/{id}/edit(id=${patient.id})}" class="btn btn-warning">Редактировать пациента</a>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function () {
        var batches = /*[[${patient.medicalDataBatches}]]*/ [];
        batches.forEach(function(batch) {
            var ctx = document.getElementById('chart-' + batch.id).getContext('2d');
            var times = [];
            var uterusData = [];
            var bpmData = [];
            batch.medicalDataList.forEach(function(data) {
                times.push(data.timeSec);
                uterusData.push(data.uterus !== 0 ? data.uterus : null);
                bpmData.push(data.bpm !== 0 ? data.bpm : null);
            });
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: times,
                    datasets: [
                        {
                            label: 'Uterus',
                            data: uterusData,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            spanGaps: true
                        },
                        {
                            label: 'BPM',
                            data: bpmData,
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.1,
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Время (сек)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Значение'
                            }
                        }
                    }
                }
            });
        });
    });
    /*]]>*/
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>