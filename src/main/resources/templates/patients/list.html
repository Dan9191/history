<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/springsecurity">
<head>
    <meta charset="UTF-8">
    <title>Список пациентов</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
</head>
<body>
<!-- Навигация -->
<div class="nav-links">
    <h4>Навигация</h4>
    <a href="/diagnoses" class="btn btn-outline-primary">Диагнозы</a>
    <a href="/logout" class="btn btn-outline-danger" sec:authorize="isAuthenticated()">Выйти</a>
</div>

<!-- Кнопка для сворачиваемого блока -->
<div class="patient-form" sec:authorize="isAuthenticated()">
    <button type="button" class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#patientFormCollapse" aria-expanded="false" aria-controls="patientFormCollapse">
        Добавить нового пациента
    </button>
</div>

<!-- Сворачиваемый блок с формой -->
<div class="collapse" id="patientFormCollapse" sec:authorize="isAuthenticated()">
    <div class="card card-body">
        <h4>Добавить нового пациента</h4>
        <form id="patientForm" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="name" class="form-label">Имя пациента *</label>
                <input type="text" class="form-control" id="name" name="name" required>
            </div>
            <div class="mb-3">
                <label for="age" class="form-label">Возраст</label>
                <input type="number" class="form-control" id="age" name="age">
            </div>
            <div class="mb-3">
                <label for="ph" class="form-label">pH</label>
                <input type="number" step="0.01" class="form-control" id="ph" name="ph">
            </div>
            <div class="mb-3">
                <label for="co2" class="form-label">CO2</label>
                <input type="number" step="0.01" class="form-control" id="co2" name="co2">
            </div>
            <div class="mb-3">
                <label for="glu" class="form-label">Глюкоза</label>
                <input type="number" step="0.01" class="form-control" id="glu" name="glu">
            </div>
            <div class="mb-3">
                <label for="lac" class="form-label">Лактат</label>
                <input type="number" step="0.01" class="form-control" id="lac" name="lac">
            </div>
            <div class="mb-3">
                <label for="be" class="form-label">BE</label>
                <input type="number" step="0.01" class="form-control" id="be" name="be">
            </div>
            <div class="mb-3">
                <label for="childbirthResultId" class="form-label">Результат родов *</label>
                <select class="form-control" id="childbirthResultId" name="childbirthResultId" required>
                    <option value="" disabled selected>Выберите результат</option>
                    <option th:each="result : ${T(dan.competition.history.model.ChildbirthResultEnum).values()}"
                            th:value="${result.id}" th:text="${result.label}"></option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Диагнозы *</label>
                <div class="diagnoses-checkboxes">
                    <div th:each="diagnosis : ${diagnoses}" class="form-check">
                        <input type="checkbox" class="form-check-input" name="diagnosesIds"
                               th:value="${diagnosis.id}" th:id="'diagnosis-' + ${diagnosis.id}">
                        <label class="form-check-label" th:for="'diagnosis-' + ${diagnosis.id}"
                               th:text="${diagnosis.name}"></label>
                    </div>
                    <div th:if="${#lists.isEmpty(diagnoses)}" class="text-muted">
                        Диагнозы не найдены
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label for="zipFile" class="form-label">ZIP-архив с медицинскими данными</label>
                <input type="file" class="form-control" id="zipFile" name="zipFile" accept=".zip">
            </div>
            <div class="mb-3">
                <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#patientFormCollapse">Закрыть</button>
                <button type="submit" class="btn btn-primary">Сохранить пациента</button>
            </div>
            <div id="errorMessage" class="error"></div>
            <div id="successMessage" class="success"></div>
        </form>
    </div>
</div>

<!-- Спиннер -->
<div id="spinnerOverlay" class="spinner-overlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Загрузка...</span>
    </div>
</div>

<!-- Таблица пациентов -->
<div class="patients-table">
    <h4>Все пациенты</h4>
    <table class="table table-striped">
        <thead>
        <tr>
            <th>ID</th>
            <th>Имя</th>
            <th>Диагнозы</th>
            <th>Батчи данных</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="patient : ${patients}"
            th:classappend="${patient.childbirthResultId == 1} ? 'income' : 'expense'">
            <td th:text="${patient.id}"></td>
            <td th:text="${patient.name}"><a th:href="@{/patients/{id}(id=${patient.id})}" th:text="${patient.name}"></a></td>
            <td>
                <span th:if="${patient.diagnoses != null and not #lists.isEmpty(patient.diagnoses)}">
                    <span th:each="diagnosis, iterStat : ${patient.diagnoses}">
                        <span th:text="${diagnosis.name}"></span>
                        <span th:if="${!iterStat.last}">,</span>
                    </span>
                </span>
                <span th:if="${patient.diagnoses == null or #lists.isEmpty(patient.diagnoses)}">
                            Нет диагнозов
                </span>
            </td>
            <td>
                <span th:if="${patient.medicalDataBatchSize != null}">
                    <span th:text="${patient.medicalDataBatchSize}"></span>
                </span>
                <span th:if="${patient.medicalDataBatchSize == null}">
                            Нет батчей
                </span>
            </td>
            <td>
                <div sec:authorize="isAuthenticated()">
                    <a th:href="@{/patients/{id}/edit(id=${patient.id})}" class="btn btn-sm btn-warning">Редактировать</a>
                    <button class="btn btn-sm btn-danger delete-patient" th:data-patient-id="${patient.id}">Удалить</button>
                </div>
            </td>
        </tr>
        <tr th:if="${#lists.isEmpty(patients)}">
            <td colspan="5">Пациенты не найдены.</td>
        </tr>
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/scripts.js"></script>
</body>
</html>